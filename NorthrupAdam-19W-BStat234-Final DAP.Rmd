---
title: "Influence of Time Since HIV Diagnosis on Seeking Sexual Information Online"
author: "Adam Northrup"
date: "March 19, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center",
                      echo = FALSE, include = FALSE, 
                      warning = FALSE, message = FALSE)
# install and load required packages
if (!require("pacman")) 
  install.packages("pacman", repos='http://cran.us.r-project.org')
p_load("tidyverse", "R2jags", "knitr", "kableExtra", "lattice")
setwd("C:/Users/anthe/Google Drive/MS Biostats/Courses/06 2019 Winter/BS 234/Bayes_FinalDAP")
theme_set(theme_bw())

load("C:/Users/anthe/Google Drive/MS Biostats/Courses/06 2019 Winter/BS 234/Labs/AddBurnin.RData")
load("ETAC/acasi.RData")
```

## Abstract  
This analysis will determine whether time since HIV diagnosis plays a role in whether an HIV-positive youth seeks health information online. Data constitutes responses from surveys administered to patients at 10 clinical sites across the country. Whether an individual seeks health information online is thought to be predicted by age, race, gender, sexual orientation, education, employment, and time since diagnosis. The event of interest, y, is a binary event, and can be characterized by the probability of the event ($\pi$). The effect will be measured using logistic regression, and will take the form of an odds ratio, $e^{\beta}$. $\beta$ is a vector of regression coefficients. Each covariate will be controlled for in determining the effect of the covariate of interest, time since HIV diagnosis. Regression coefficients are expected to follow a normal distribution with mean zero and high variance. Survey results from each site may be correlated, and so a site-specific effect will be considered.  

```{r data}
acasi3 <- acasi2 %>%
  filter(!is.na(SCREEN1)) %>%
  filter(BORNHIV == 0) %>%
  arrange(SITE1) %>%
  mutate(Site = as.numeric(as.factor(SITE1)),
         ID = 1:n(),
         HealthInfo = if_else(S56_24XL + S56_24XM + S56_24XN + S56_24XO > 0 &
                                S56_24XL + S56_24XM + S56_24XN + S56_24XO < 8,
                              1, 0)) %>%
  select(Site, ID, BORNHIV, DIAGHIV, SCREEN1, ORIENT, GENDER, GRADE, 
         LATINO, starts_with("RACE"), -RACE, -RACEFS,
         contains("EMPLOY"), -EMPLOY, -EMPLOYE, -EMPLOYF, HealthInfo) %>%
  mutate(SINCEHIV = 2019 - DIAGHIV) %>%
  mutate_at(vars(RACE_RC, ORIENT, GENDER, GRADE),
            funs(as.factor)) %>%
  mutate(ORIENT_RC = fct_recode(as.factor(ORIENT),
                                "Straight"          = "1", 
                                "Lesbian or gay"    = "2", 
                                "Other orientation" = "3",
                                "Other orientation" = "4", 
                                "Other orientation" = "5", 
                                "Other orientation" = "7",
                                "Refuse to answer"  = "8"),
         GENDER_RC = fct_recode(GENDER,
                                "Cis man"          = "1", 
                                "Cis woman"        = "2",
                                "Trans man"        = "3", 
                                "Trans woman"      = "4",
                                "Other gender"     = "5", 
                                "Other gender"     = "6",
                                "Refuse to answer" = "8"),
         GRADE_RC = fct_recode(as.factor(GRADE),
                               "High school, equivalent or less"  = "1", 
                               "High school, equivalent or less"  = "2", 
                               "High school, equivalent or less"  = "3", 
                               "More than high school"            = "4", 
                               "More than high school"            = "5", 
                               "More than high school"            = "6",
                               "More than high school"            = "7", 
                               "Refuse to answer"                 = "8"),
         RACE_RC = case_when(LATINO == 1 ~ "Latino",
                             RACEC == 1 ~ "Black, Not Latino",
                             RACEE == 1 ~ "White, Not Latino",
                             TRUE ~ "Other race")) %>%
  unite("ORIENT_GENDER", ORIENT_RC, GENDER_RC, sep = " ", remove = FALSE) %>%
  mutate(ORIENT_GENDER = fct_lump(as.factor(ORIENT_GENDER),
                                  n = 5,
                                  other_level = "Other Orientation/Gender"),
         ORIENT_GENDER = fct_recode(ORIENT_GENDER,
                                    "Gay cis man" = "Lesbian or gay Cis man",
                                    "Lesbian trans woman" = "Lesbian or gay Trans woman"))
table(acasi3$ORIENT_GENDER)
y <- acasi3$HealthInfo
x <- model.matrix(~ SINCEHIV + SCREEN1 + RACE_RC + ORIENT_GENDER +
                    GRADE_RC + 
                    EMPLOYA + EMPLOYB + EMPLOYC + EMPLOYD + EMPLOYE_RC, 
                  data = acasi3)
```

```{r summary}
#####Create summary tables
#Functions
tab1_OneFactor <- function (x, varString, varRelevel = NULL) {
  varName <- str_replace(varString, " ", ".")
  x %>%
      select(varString) %>%
      table() %>%
      as.data.frame(., stringsAsFactors = FALSE) %>%
      setNames(c("Variable", "N")) %>%
      mutate(Percent = scales::percent(N / sum(N), accuracy = 0.1)) %>%
    unite("Frequency", N, Percent, sep = " (") %>%
    mutate(Frequency = str_replace(Frequency, "(.*)", "\\1)"),
           Variable = as.character(Variable)) %>%
    mutate(Variable = fct_relevel(as.factor(Variable), varRelevel)) %>%
    arrange(Variable) %>%
    mutate(Variable = as.character(Variable))
}

tab1_ManyBinary <- function (x, ..., response = 1) {
  selectVars <- quos(...)
  selectStrings <- gsub("~|`", "", as.character(selectVars))
  x %>%
    select(!!! selectVars) %>%
    summarize_all(funs(N = length(which(. == response)),
                       P = length(which(. == response)) /
                         length(which(!is.na(.))))) %>%
                         {
                           full_join(select(., -contains("_P")) %>%
                                       gather("Variable", "N", contains("_N")) %>%
                                       mutate(Variable = str_replace(Variable, "_N", "")),
                                     select(., -contains("_N")) %>%
                                       gather("Variable", "P", contains("_P")) %>%
                                       mutate(Variable = str_replace(Variable, "_P", "")),
                                     by = "Variable")
                         } %>%
    mutate(P = scales::percent(P, accuracy = 0.1)) %>%
    unite("Frequency", N, P, sep = " (") %>%
    mutate(Frequency = str_replace(Frequency, "(.*)", "\\1)")) %>%
    mutate(Variable = factor(Variable, levels = selectStrings)) %>%
    arrange(Variable) %>%
    mutate(Variable = as.character(Variable))
}

#Create summary table
demo <- acasi3 %>%
  rename(`Student` = EMPLOYA,
         `Full-time employed` = EMPLOYB,
         `Part-time employed` = EMPLOYC,
         `Disabled` = EMPLOYD,
         `Unemployed` = EMPLOYE_RC)

table1 <- bind_rows(
  demo %>%
      summarize(Variable = "Number of participants",
                Frequency = as.character(n())),
  bind_rows(
    demo %>%
      summarize(Variable = "Age",
                Mean = mean(SCREEN1),
                SD = sd(SCREEN1)),
    demo %>%
      summarize(Variable = "Time since HIV diagnosis",
                Mean = mean(SINCEHIV),
                SD = sd(SINCEHIV))
  ) %>%
    mutate_if(is.numeric, funs(round), 1) %>%
    unite("Frequency", Mean, SD, sep = " (") %>%
    mutate(Frequency = paste0(Frequency, ")")),
  tab1_OneFactor(demo, varString = "ORIENT_GENDER"),
  tab1_OneFactor(demo, varString = "RACE_RC", 
                 varRelevel = c("Latino", "Black, Not Latino",
                                "White, Not Latino")),
  tab1_OneFactor(demo, varString = "GRADE_RC",
                 varRelevel = c("High school, equivalent or less")),
  tab1_ManyBinary(demo, Student, `Full-time employed`, `Part-time employed`, 
                Disabled, Unemployed)
)
```

```{r model}
cat(
"model{
  for (i in 1:N.obs) {
		y[i] ~ dbern(pie[i])
    logit(pie[i]) <- inprod(x[], alpha[]) + beta[id[i]]
  }
  for (j in 1:N.sites) {
    beta[j] ~ dnorm(0, tau.b)
  }
  alpha[2] ~ 
  tau.b ~ 
}",
  fill = TRUE,
	file = "model_logit_mixed.txt")

```


```{r summaryTable}
kable(table1) %>%
  kable_styling(bootstrap_options = c("striped", "condensed"),
                full_width = FALSE)
```

