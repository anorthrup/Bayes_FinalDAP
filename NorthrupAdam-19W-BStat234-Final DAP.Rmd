---
title: "Influence of Time Since HIV Diagnosis on Seeking Sexual Information Online"
author: "Adam Northrup"
date: "March 19, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center",
                      echo = FALSE, include = FALSE, 
                      warning = FALSE, message = FALSE)
# install and load required packages
if (!require("pacman")) 
  install.packages("pacman", repos='http://cran.us.r-project.org')
p_load("tidyverse", "R2jags", "knitr", "kableExtra", "lattice")
setwd("C:/Users/anthe/Google Drive/MS Biostats/Courses/06 2019 Winter/BS 234/Bayes_FinalDAP")
theme_set(theme_bw())

load("C:/Users/anthe/Google Drive/MS Biostats/Courses/06 2019 Winter/BS 234/Labs/AddBurnin.RData")
load("models_1_2_3.RData")
```

## Abstract  
This analysis will determine whether time since HIV diagnosis plays a role in whether an HIV-positive youth seeks health information online. Data constitutes responses from surveys administered to patients at 10 clinical sites across the country. The effect of time since diagnosis will be evaluated when controlling for as age, race, gender, sexual orientation, education, and employment status. The event of interest, y, is a binary event, and can be characterized by the probability of the event ($\pi$). The effect of time will be measured using logistic regression, and will take the form of an odds ratio, $e^{\alpha}$. $\alpha$ is a vector of regression coefficients. Regression coefficients are expected to follow different normal distributions, with expectations taken from prior research. Survey results from each site may be correlated, and so a site-specific effect will be considered.  

```{r data, eval = FALSE}
acasi3 <- acasi2 %>%
  filter(!is.na(SCREEN1)) %>%
  filter(BORNHIV == 0) %>%
  arrange(SITE1) %>%
  mutate(Site = as.numeric(as.factor(SITE1)),
         ID = 1:n(),
         HealthInfo = if_else(S56_24XL + S56_24XM + S56_24XN + S56_24XO > 0 &
                                S56_24XL + S56_24XM + S56_24XN + S56_24XO < 8,
                              1, 0)) %>%
  select(Site, ID, BORNHIV, DIAGHIV, SCREEN1, ORIENT, GENDER, GRADE, 
         LATINO, starts_with("RACE"), -RACE, -RACEFS,
         contains("EMPLOY"), -EMPLOY, -EMPLOYE, -EMPLOYF, HealthInfo) %>%
  mutate_at(vars(RACE_RC, ORIENT, GENDER, GRADE, starts_with("EMPLOY")),
            funs(as.factor)) %>%
  mutate(SINCEHIV = 2019 - DIAGHIV,
         LGBTQ = if_else(ORIENT == 1 & GENDER %in% c(1, 2), 0, 1),
         GENDER_RC = fct_recode(GENDER,
                                 "Man"              = "1", 
                                 "Woman"            = "2",
                                 "Man"              = "3", 
                                 "Woman"            = "4",
                                 "Other gender"     = "5", 
                                 "Other gender"     = "6",
                                 "Refuse to answer" = "8"),
         GRADE_RC = fct_recode(as.factor(GRADE),
                               "High school, equivalent or less"  = "1", 
                               "High school, equivalent or less"  = "2", 
                               "High school, equivalent or less"  = "3", 
                               "More than high school"            = "4", 
                               "More than high school"            = "5", 
                               "More than high school"            = "6",
                               "More than high school"            = "7", 
                               "Refuse to answer"                 = "8"),
         RACE_RC = case_when(LATINO == 1 ~ "Latino",
                             RACEC == 1 ~ "Black, Not Latino",
                             RACEE == 1 ~ "White, Not Latino",
                             TRUE ~ "Other race"),
         EMPLOYB_RC = if_else(EMPLOYB == 1 | EMPLOYC == 1, 1, 0),
         EMPLOYA = fct_recode(EMPLOYA, "A" = "1"),
         EMPLOYB_RC = fct_recode(as.factor(EMPLOYB_RC), "B" = "1"),
         EMPLOYD = fct_recode(EMPLOYD, "D" = "1"),
         EMPLOYE_RC = fct_recode(EMPLOYE_RC, "E" = "1"),
         EMPLOY = str_replace_all(
           paste0(EMPLOYA, EMPLOYB_RC, EMPLOYD, EMPLOYE_RC),
           "0", ""
         ),
         EMPLOY = fct_lump(as.factor(EMPLOY), n = 5),
         EMPLOY = fct_recode(EMPLOY,
                             "Student" = "A",
                             "Student" = "AB",
                             "Employed" = "B",
                             "Disabled" = "D",
                             "Unemployed" = "E")) %>%
  select(Site, ID, HealthInfo, SINCEHIV, SCREEN1, LGBTQ, GENDER_RC, 
         GRADE_RC, RACE_RC, EMPLOY) %>%
  rename(Age = SCREEN1)

y <- acasi3$HealthInfo
x <- acasi3 %>%
  mutate(Intercept = 1,
         Gender_Woman = if_else(GENDER_RC == "Woman", 1, 0),
         Gender_Other = if_else(GENDER_RC == "Other gender", 1, 0),
         Ed_Higher = if_else(GRADE_RC == "More than high school", 1, 0),
         Race_Black = if_else(RACE_RC == "Black, Not Latino", 1, 0),
         Race_White = if_else(RACE_RC == "White, Not Latino", 1, 0),
         Race_Other = if_else(RACE_RC == "Other race", 1, 0),
         Employ_Student = if_else(EMPLOY == "Student", 1, 0),
         Employ_Employed = if_else(EMPLOY == "Employed", 1, 0),
         Employ_Disabled = if_else(EMPLOY == "Disabled", 1, 0),
         Employ_Other = if_else(EMPLOY == "Other", 1, 0)) %>%
  select(Intercept, SINCEHIV, Age, starts_with("Gender_"), Ed_Higher, 
         starts_with("Race_"), starts_with("Employ_"),
         -GENDER_RC, -RACE_RC) %>%
  as.matrix()
```

```{r summary}
#####Create summary tables
#Functions
tab1_OneFactor <- function (x, varString, varRelevel = NULL) {
  varQuo <- enquo(varString)
  x %>%
    select(HealthInfo, !!varQuo) %>%
    group_by(!!varQuo) %>%
    summarize(N = n(),
              P = n() / nrow(.),
              N.y = sum(HealthInfo),
              P.y = sum(HealthInfo) / length(HealthInfo)) %>%
    arrange(desc(N)) %>%
    mutate(`Sample Frequency` = paste0(N, 
                                       " (", 
                                       scales::percent(P, accuracy = 0.1),
                                       ")"),
           `Seeking Health Info` = paste0(N.y, 
                                       " (", 
                                       scales::percent(P.y, accuracy = 0.1),
                                       ")")) %>%
    rename(Variable = !!varQuo) %>%
    select(-N, - P, -N.y, -P.y) %>%
    mutate(Variable = fct_relevel(factor(Variable, levels = unique(Variable)), 
                                  varRelevel)) %>%
    arrange(Variable) %>%
    mutate(Variable = as.character(Variable))
}

tab1_ManyBinary <- function (x, ..., response = 1) {
  selectVars <- quos(...)
  x %>%
    select(HealthInfo, !!!selectVars) %>%
    gather("Variable", "Value", -HealthInfo) %>%
    group_by(Variable) %>%
    summarize(N = sum(Value),
              P = sum(Value) / n(),
              N.y = sum(HealthInfo[which(Value == 1)]),
              P.y = sum(HealthInfo[which(Value == 1)]) / 
                length(HealthInfo[which(Value == 1)])) %>%
    arrange(desc(N)) %>%
    mutate(`Sample Frequency` = paste0(N, 
                                       " (", 
                                       scales::percent(P, accuracy = 0.1),
                                       ")"),
           `Seeking Health Info` = paste0(N.y, 
                                       " (", 
                                       scales::percent(P.y, accuracy = 0.1),
                                       ")")) %>%
    select(-N, - P, -N.y, -P.y)
}

#Create summary table
demo <- acasi3 %>%
  mutate(LGBTQ = fct_recode(as.factor(LGBTQ),
                            "Non-LGBTQ" = "0", 
                            "LGBTQ" = "1"))

table1 <- bind_rows(
  demo %>%
      summarize(Variable = "Number of participants",
                `Sample Frequency` = as.character(n())),
  bind_rows(
    demo %>%
      summarize(Variable = "Age",
                Mean = mean(Age),
                SD = sd(Age)),
    demo %>%
      summarize(Variable = "Time since HIV diagnosis",
                Mean = mean(SINCEHIV),
                SD = sd(SINCEHIV))
  ) %>%
    mutate_if(is.numeric, funs(round), 1) %>%
    unite("Sample Frequency", Mean, SD, sep = " (") %>%
    mutate(`Sample Frequency` = paste0(`Sample Frequency`, ")")),
  tab1_OneFactor(demo, varString = LGBTQ),
  tab1_OneFactor(demo, varString = GENDER_RC),
  tab1_OneFactor(demo, varString = RACE_RC),
  tab1_OneFactor(demo, varString = GRADE_RC),
  tab1_OneFactor(demo, varString = EMPLOY)
)

demoPlots <- demo %>%
  mutate(HealthInfo = fct_recode(as.factor(HealthInfo),
                                 "Seeks Info" = "1",
                                 "Does Not Seek Info" = "0"))
plotAge <- ggplot(demoPlots, aes(x = Age, fill = factor(HealthInfo))) +
  geom_histogram(binwidth = 1, show.legend = FALSE) +
  facet_grid(~HealthInfo) +
  labs(y = "Count", title = "Distribution of Age Stratified by Health Information Seeking")
plotSINCEHIV <- ggplot(demoPlots, aes(x = SINCEHIV, fill = factor(HealthInfo))) +
  geom_histogram(binwidth = 1, show.legend = FALSE) +
  facet_grid(~HealthInfo) +
  labs(y = "Count", title = "Distribution of Time Since HIV Diagnosis Stratified by Health Information Seeking")

plotCorr <- ggplot(demoPlots, aes(x = Age, y = SINCEHIV, color = HealthInfo)) +
  geom_point(position = position_jitter(), show.legend = FALSE) +
  facet_grid(~HealthInfo) +
  labs(y = "Time Since HIV Diagnosis (yr)", x = "Age (yr)",
       title = "Age Against Time Since Diagnosis, Separated by Outcome")
corAgeSinceHIV <- cor(x[, 2:3])[1, 2]
```

```{r model1}
cat(
"model{
  for (i in 1:N.obs) {
		y[i] ~ dbern(pie[i])
    logit(pie[i]) <- inprod(x[i, ], alpha[]) + beta[site[i]]
  }
  for (j in 1:N.sites) {
    beta[j] ~ dnorm(0, tau)
  }
  alpha[1] ~ dnorm(0, 1)
  alpha[2] ~ dnorm(-1, 1)
  alpha[3] ~ dnorm(1, 1)
  alpha[4] ~ dnorm(1, 1)
  alpha[5] ~ dnorm(1, 1)
  alpha[6] ~ dnorm(1, 1)
  alpha[7] ~ dnorm(0, 1)
  alpha[8] ~ dnorm(0, 1)
  alpha[9] ~ dnorm(0, 1)
  alpha[10] ~ dnorm(1, 1)
  alpha[11] ~ dnorm(1, 1)
  alpha[12] ~ dnorm(1, 1)
  alpha[13] ~ dnorm(0, 1)
  tau ~ dgamma(b1, b2)
  sigma <- 1/ tau
}",
  fill = TRUE,
	file = "model1_logit_mixed.txt")
```

```{r model2}
cat(
"model{
  for (i in 1:N.obs) {
		y[i] ~ dbern(pie[i])
    logit(pie[i]) <- inprod(x[i, ], alpha[]) + beta[site[i]]
  }
  for (j in 1:N.sites) {
    beta[j] ~ dnorm(0, tau)
  }
  alpha[1] ~ dnorm(0, 1)
  alpha[2] ~ dnorm(-1, 1)
  alpha[3] ~ dnorm(1, 1)
  alpha[4] ~ dnorm(1, 1)
  alpha[5] ~ dnorm(1, 1)
  alpha[6] ~ dnorm(0, 1)
  alpha[7] ~ dnorm(0, 1)
  alpha[8] ~ dnorm(0, 1)
  alpha[9] ~ dnorm(1, 1)
  alpha[10] ~ dnorm(1, 1)
  alpha[11] ~ dnorm(1, 1)
  alpha[12] ~ dnorm(0, 1)
  tau ~ dgamma(b1, b2)
  sigma <- 1/ tau
}",
  fill = TRUE,
	file = "model2_logit_mixed.txt")
```

```{r model3}
cat(
"model{
  for (i in 1:N.obs) {
		y[i] ~ dbern(pie[i])
    logit(pie[i]) <- inprod(x[i, ], alpha[])
  }
  alpha[1] ~ dnorm(0, 1)
  alpha[2] ~ dnorm(-1, 1)
  alpha[3] ~ dnorm(1, 1)
  alpha[4] ~ dnorm(1, 1)
  alpha[5] ~ dnorm(1, 1)
  alpha[6] ~ dnorm(1, 1)
  alpha[7] ~ dnorm(0, 1)
  alpha[8] ~ dnorm(0, 1)
  alpha[9] ~ dnorm(0, 1)
  alpha[10] ~ dnorm(1, 1)
  alpha[11] ~ dnorm(1, 1)
  alpha[12] ~ dnorm(1, 1)
  alpha[13] ~ dnorm(0, 1)
  tau ~ dgamma(b1, b2)
  sigma <- 1/ tau
}",
  fill = TRUE,
	file = "model3_logit_fixed.txt")
```

```{r runMod1, eval = FALSE}
parameters <- c("pie", "alpha", "beta", "sigma")

initsMod1 <- rep(
  list(
    list(
      alpha = rep(0, 13),  
      beta  = rep(0, length(unique(acasi3$Site))),  
      tau   = 1)
  ),
  5
)

priorDataMod1 = list(N.obs = nrow(acasi3), 
                     N.sites = length(unique(acasi3$Site)),
                     site = acasi3$Site,
                     b1 = 0.25, 
                     b2 = 0.25,
                     y = y, 
                     x = x)
proc.time()
runMod1 = jags(priorDataMod1, initsMod1, parameters, 
               "model1_logit_mixed.txt", 
               n.chains = 5, n.iter = 8100, n.burnin = 0, n.thin = 1)
proc.time()
burnMod1 <- AddBurnin(runMod1$BUGSoutput$sims.array, 
                      burnin = 100, n.thin = 8)
```

```{r runMod2, eval = FALSE}
initsMod2 <- rep(
  list(
    list(
      alpha = rep(0, 12),  
      beta  = rep(0, length(unique(acasi3$Site))),  
      tau   = 1)
  ),
  5
)

priorDataMod2 = list(N.obs = nrow(acasi3), 
                     N.sites = length(unique(acasi3$Site)),
                     site = acasi3$Site,
                     b1 = 0.25, 
                     b2 = 0.25,
                     y = y, 
                     x = x[, -3])
proc.time()
runMod2 = jags(priorDataMod2, initsMod2, parameters, 
               "model2_logit_mixed.txt", 
               n.chains = 5, n.iter = 8100, n.burnin = 0, n.thin = 1)
proc.time()
burnMod2 <- AddBurnin(runMod2$BUGSoutput$sims.array, 
                      burnin = 100, n.thin = 8)
```

```{r runMod3, eval = FALSE}
initsMod3 <- rep(
  list(
    list(
      alpha = rep(0, 13),  
      tau   = 1)
  ),
  5
)

priorDataMod3 = list(N.obs = nrow(acasi3), 
                     b1 = 0.25, 
                     b2 = 0.25,
                     y = y, 
                     x = x)
proc.time()
runMod3 = jags(priorDataMod3, initsMod3, parameters, 
               "model3_logit_fixed.txt", 
               n.chains = 5, n.iter = 8100, n.burnin = 0, n.thin = 1)
proc.time()
burnMod3 <- AddBurnin(runMod3$BUGSoutput$sims.array, 
                      burnin = 100, n.thin = 8)
```

```{r jagsPlots}
plotACF <- function (burn, n, name, model = NULL, lag.max = NULL) {
  for(i in 1:length(name)) {
    acf(burn$Burnin.sims.matrix[1:n, name[1]], lag.max = lag.max, 
        main = paste(model, name[i]))
  }
}
plotTime <- function (burn, n, name, model = NULL, ylim = NULL) {
  for(i in 1:length(name)) {
    plot(1:n, burn$Burnin.sims.matrix[1:n, name[1]], type = "l", 
         main = paste(model, name[i]), ylab = name[i], xlab = "Iteration",
         ylim = ylim)
  }
}
par(mfrow = c(2, 3))
plotACF(burnMod1, n = 1000, "sigma", "Model 1")
plotACF(burnMod2, n = 1000, "sigma", "Model 2")
plotACF(burnMod3, n = 1000, "sigma", "Model 3")
plotTime(burnMod1, n = 1000, "sigma", "Model 1", ylim = c(0, 3))
plotTime(burnMod2, n = 1000, "sigma", "Model 2", ylim = c(0, 3))
plotTime(burnMod3, n = 1000, "sigma", "Model 3", ylim = c(0, 3))

par(mfrow = c(2, 3))
plotACF(burnMod2, n = 1000, paste0("alpha[", 1:6, "]"), "Model 2")
plotACF(burnMod2, n = 1000, paste0("alpha[", 7:12, "]"), "Model 2")
par(mfrow = c(3, 2))
plotTime(burnMod2, n = 1000, paste0("alpha[", 1:6, "]"), "Model 2")
plotTime(burnMod2, n = 1000, paste0("alpha[", 7:12, "]"), "Model 2")
# dicMod1 <- runMod1$BUGSoutput$DIC
# dicMod2 <- runMod2$BUGSoutput$DIC
# dicMod3 <- runMod3$BUGSoutput$DIC
```

```{r diagnostics}
sumMod2 <- burnMod2$Burnin.Summary %>%
  as.data.frame() %>%
  rownames_to_column("Parameter") %>%
  setNames(c("Parameter", "Mean", "SD", "2.5%", "97.5%", "P>0"))
alphaMod2 <- sumMod2$Mean[str_detect(sumMod2$Parameter, "alpha")]
betaMod2 <- sumMod2$Mean[str_detect(sumMod2$Parameter, "beta")]
piMod2 <- sumMod2$Mean[str_detect(sumMod2$Parameter, "pie")]
diagMod2 <- tibble(y = y,
                   pi = piMod2, 
                   logitPi = log(pi / (1 - pi)),
                   SINCEHIV = x[, 2],
                   a2 = alphaMod2[2],
                   color = "1") %>%
  mutate(xa = SINCEHIV * a2)
ggplot(diagMod2, aes(x = SINCEHIV, y = pi, color = "black")) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE) +
  geom_point(aes(y = y, color = "blue")) +
  geom_smooth(aes(y = y, color = "blue"), method = "loess", se = FALSE) +
  labs(y = "", title = "Pi and Y against Time Since HIV Diagnosis",
       x = "Time Since HIV (yr)") +
  scale_color_manual(name = 'Y Axis', 
         values =c('black'='black','blue'='blue'), labels = c('Pi','Health Info'))
```

```{r plotPosterior}
priorMeans <- c(0, -1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0)
priorX <- double(485220)
likeliX <- double(485220)
likeliMod <- lm(HealthInfo ~ SINCEHIV + Gender_Woman + Gender_Other +
                  Ed_Higher + Race_Black + Race_White + Race_Other +
                  Employ_Student + Employ_Employed + Employ_Disabled + 
                  Employ_Other, 
                 data = bind_cols(
                   tibble(HealthInfo = y), 
                   as.tibble(x[, c(-1 ,-3)])))
likeliMeans <- likeliMod$coefficients
likeliSDs <- summary(likeliMod)$coefficients[, "Std. Error"]
for (i in 1:length(priorMeans)) {
  priorX[(40435*i - 40434):(40435*i)] <- rnorm(40435, priorMeans[i], 1)
  likeliX[(40435*i - 40434):(40435*i)] <- rnorm(40435, 
                                                likeliMeans[i],
                                                likeliSDs[i])
}
alphaNames <- paste0("alpha[", 1:12, "]") %>%
  setNames(colnames(x[, -3]))
postMod2 <- burnMod2$Burnin.sims.matrix %>%
  as.data.frame() %>%
  select(contains("alpha")) %>%
  gather("Key", "Posterior") %>%
  mutate(Key = fct_recode(factor(Key, levels = unique(Key)),
                                 !!!alphaNames),
         Prior = priorX,
         Likelihood = likeliX)
ggplot(postMod2 %>%
         filter(Key == "SINCEHIV"),
       aes(x = Posterior, fill = "posterior")) +
  geom_density() +
  geom_density(aes(x = Prior, fill = "prior")) +
  geom_density(aes(x = Likelihood, fill = "likeli")) +
  scale_x_continuous(limits = c(-2, 0.1)) +
  # scale_y_continuous(limits = c(0, 20)) +
  scale_fill_manual(name = "Distribution",
                     values = c("likeli" = "blue",
                                "posterior" = "green", 
                                "prior" = "red"),                     
                     labels = c("Likelihood", "Posterior", "Prior")) +
  labs(y = "Density", x = "Time Since HIV Coefficient",
       title = "Time Since HIV Regression Coefficient Distributions")
ggplot(postMod2 %>%
         filter(Key == "SINCEHIV") %>%
         gather("Distribution", "Data", -Key),
       aes(x = Data, fill = Distribution)) +
  facet_grid(.~Distribution, scales = "free") +
  geom_density() +
  labs(y = "Density", x = "Time Since HIV Coefficient",
       title = "Time Since HIV Regression Coefficient Distributions")
```

```{r summaryTable}
kable(table1) %>%
  kable_styling(bootstrap_options = c("striped", "condensed"),
                full_width = FALSE)
```

