---
title: "Influence of Time Since HIV Diagnosis on Seeking Sexual Information Online"
author: "Adam Northrup"
date: "March 19, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center",
                      echo = FALSE, include = FALSE, 
                      warning = FALSE, message = FALSE)
# install and load required packages
if (!require("pacman")) 
  install.packages("pacman", repos='http://cran.us.r-project.org')
p_load("tidyverse", "R2jags", "knitr", "kableExtra", "lattice")
setwd("C:/Users/anthe/Google Drive/MS Biostats/Courses/06 2019 Winter/BS 234/Final DAP/")
theme_set(theme_bw())

load("C:/Users/anthe/Google Drive/MS Biostats/CTourses/06 2019 Winter/BS 234/Labs/AddBurnin.RData")
load("ETAC/acasi.RData")
```

## Abstract  
This analysis will determine whether time since HIV diagnosis plays a role in whether an HIV-positive youth seeks health information online. Data constitutes responses from surveys administered to patients at 10 clinical sites across the country. Whether an individual seeks health information online is thought to be predicted by age, race, gender, sexual orientation, education, employment, and time since diagnosis. The event of interest, y, is a binary event, and can be characterized by the probability of the event ($\pi$). The effect will be measured using logistic regression, and will take the form of an odds ratio, $e^{\beta}$. $\beta$ is a vector of regression coefficients. Each covariate will be controlled for in determining the effect of the covariate of interest, time since HIV diagnosis. Regression coefficients are expected to follow a normal distribution with mean zero and high variance. Survey results from each site may be correlated, and so a site-specific effect will be considered.  

```{r data}
acasi3 <- acasi2 %>%
  filter(!is.na(SCREEN1)) %>%
  filter(BORNHIV == 0) %>%
  arrange(SITE1) %>%
  mutate(Site = as.numeric(as.factor(SITE1)),
         ID = 1:n(),
         HealthInfo = if_else(S56_24XL + S56_24XM + S56_24XN + S56_24XO > 0 &
                                S56_24XL + S56_24XM + S56_24XN + S56_24XO < 8,
                              1, 0)) %>%
  select(Site, ID, BORNHIV, DIAGHIV, SCREEN1, RACE_RC, SEXBRTH, GENDER_RC, 
         ORIENT_RC, GRADE_RC, 
         contains("EMPLOY"), -EMPLOY, -EMPLOYE, -EMPLOYF, HealthInfo) %>%
  mutate(SINCEHIV = 2019 - DIAGHIV) %>%
  mutate_at(vars(RACE_RC, SEXBRTH, GENDER_RC, ORIENT_RC, GRADE_RC),
            funs(as.factor)) %>%
  mutate(SEXBRTH = fct_recode(SEXBRTH,
                              "Male" = "1",
                              "Female" = "2"),
         GENDER_RC = fct_recode(GENDER_RC,
                                "Man" = "Male (cis man)",
                                "Woman" = "Female (cis woman)",
                                "Transgender" = "Trans person"))
y <- acasi3$HealthInfo
x <- model.matrix(~ SINCEHIV + SCREEN1 + RACE_RC + GENDER_RC + ORIENT_RC +
                    GRADE_RC + 
                    EMPLOYA + EMPLOYB + EMPLOYC + EMPLOYD + EMPLOYE_RC, 
                  data = acasi3)
```

```{r summary}
#####Create summary tables
#Functions
tab1_OneFactor <- function (x, varString, varRelevel = NULL) {
  varName <- str_replace(varString, " ", ".")
  x %>%
      select(varString) %>%
      table() %>%
      as.data.frame(., stringsAsFactors = FALSE) %>%
      setNames(c("Variable", "N")) %>%
      mutate(Percent = scales::percent(N / sum(N), accuracy = 0.1)) %>%
    unite("Frequency", N, Percent, sep = " (") %>%
    mutate(Frequency = str_replace(Frequency, "(.*)", "\\1)"),
           Variable = as.character(Variable)) %>%
    mutate(Variable = fct_relevel(as.factor(Variable), varRelevel)) %>%
    arrange(Variable) %>%
    mutate(Variable = as.character(Variable))
}

tab1_ManyBinary <- function (x, ..., response = 1) {
  selectVars <- quos(...)
  selectStrings <- gsub("~|`", "", as.character(selectVars))
  x %>%
    select(!!! selectVars) %>%
    summarize_all(funs(N = length(which(. == response)),
                       P = length(which(. == response)) /
                         length(which(!is.na(.))))) %>%
                         {
                           full_join(select(., -contains("_P")) %>%
                                       gather("Variable", "N", contains("_N")) %>%
                                       mutate(Variable = str_replace(Variable, "_N", "")),
                                     select(., -contains("_N")) %>%
                                       gather("Variable", "P", contains("_P")) %>%
                                       mutate(Variable = str_replace(Variable, "_P", "")),
                                     by = "Variable")
                         } %>%
    mutate(P = scales::percent(P, accuracy = 0.1)) %>%
    unite("Frequency", N, P, sep = " (") %>%
    mutate(Frequency = str_replace(Frequency, "(.*)", "\\1)")) %>%
    mutate(Variable = factor(Variable, levels = selectStrings)) %>%
    arrange(Variable) %>%
    mutate(Variable = as.character(Variable))
}

#Create summary table
demo <- acasi3 %>%
  rename(`Student` = EMPLOYA,
         `Full-time employed` = EMPLOYB,
         `Part-time employed` = EMPLOYC,
         `Disabled` = EMPLOYD,
         `Unemployed` = EMPLOYE_RC)

table1 <- bind_rows(
  demo %>%
      summarize(Variable = "Number of participants",
                Frequency = as.character(n())),
  bind_rows(
    demo %>%
      summarize(Variable = "Age",
                Mean = mean(SCREEN1),
                SD = sd(SCREEN1)),
    demo %>%
      summarize(Variable = "Time since HIV diagnosis",
                Mean = mean(SINCEHIV),
                SD = sd(SINCEHIV))
  ) %>%
    mutate_if(is.numeric, funs(round), 1) %>%
    unite("Frequency", Mean, SD, sep = " (") %>%
    mutate(Frequency = paste0(Frequency, ")")),
  tab1_OneFactor(demo, varString = "SEXBRTH", varRelevel = "Male"),
  tab1_OneFactor(demo, varString = "GENDER_RC", 
                 varRelevel = c("Man", "Woman", "Transgender")),
  tab1_OneFactor(demo, varString = "ORIENT_RC",
                 varRelevel = c("Straight", "Lesbian or gay",
                                "Bisexual")),
  tab1_OneFactor(demo, varString = "RACE_RC", 
               varRelevel = c("Latino", "Black, Not Latino",
                              "White, Not Latino", 
                              "White Mixed-Race, Not Latino or Black")),
  tab1_OneFactor(demo, varString = "GRADE_RC",
                 varRelevel = c("High school, equivalent or less",
                                "Some post-K12")),
  tab1_ManyBinary(demo, Student, `Full-time employed`, `Part-time employed`, 
                Disabled, Unemployed)
)
```

```{r model}
cat(
"model{
  for (i in 1:N.obs) {
		y[i] ~ dbern(pie[i])
    logit(pie[i]) <- inprod(x[], alpha[]) + beta[id[i]]
  }
  for (j in 1:N.sites) {
    beta[j] ~ dnorm(0, tau.b)
  }
  alpha[2] ~ 
  tau.b ~ 
}",
  fill = TRUE,
	file = "model_logit_mixed.txt")

```


```{r summaryTable}
kable(table1) %>%
  kable_styling(bootstrap_options = c("striped", "condensed"),
                full_width = FALSE)
```

